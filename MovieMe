from pathlib import Path
import pandas as pd
import zipfile
import warnings
import numpy as np
import random
import streamlit as st

warnings.filterwarnings("ignore", message="Sparse CSR tensor support is in beta state")

EXPLICIT_PATH = r""

def _ensure_extracted(zpath: Path):
    if not zpath.exists() or zpath.suffix.lower() != ".zip":
        return
    try:
        with zipfile.ZipFile(zpath, "r") as zf:
            zf.extractall(zpath.parent)
        print(f"Extracted: {zpath} -> {zpath.parent}")
    except Exception as e:
        print(f"Could not extract {zpath}: {e}")

def _has_files(d: Path) -> bool:
    return (d / "ratings.csv").exists() and (d / "movies.csv").exists()

def find_movielens_dir(preferred: str | None = None) -> Path:
    home = Path.home()
    script_dir = Path(__file__).resolve().parent if "__file__" in globals() else Path.cwd()
    bases = []
    if preferred:
        p = Path(preferred)
        if p.suffix.lower() == ".zip":
            _ensure_extracted(p)
            bases.append(p.parent)
        else:
            bases.append(p)
    bases += [
        Path.cwd(),
        script_dir,
        home / "Downloads",
        home / "Desktop",
        home / "Documents",
    ]
    for b in bases:
        if _has_files(b):
            return b
        for cand in [b / "ml-latest-small", b / "ml-latest-small (1)"]:
            if _has_files(cand):
                return cand
        for cand in b.glob("ml-latest-small*"):
            if cand.is_dir() and _has_files(cand):
                return cand
        for z in b.glob("ml-latest-small*.zip"):
            _ensure_extracted(z)
    for b in bases:
        try:
            for rc in b.rglob("ratings.csv"):
                parent = rc.parent
                if (parent / "movies.csv").exists():
                    return parent
        except Exception:
            pass
    checked = "\n  - " + "\n  - ".join(str(p) for p in bases)
    raise FileNotFoundError(
        "Could not find a folder containing ratings.csv and movies.csv.\nChecked:" + checked
    )




def norm(v):
    n = np.linalg.norm(v)     
    return v / n if n > 0 else v


favG_vals = []



def user_pref(fav_genres,genre_cols1):
    UMatrix = np.zeros(len(genre_cols1))
    for i in range(len(UMatrix)):
        if genre_cols1[i] in fav_genres:
            UMatrix[i] = 1
            favG_vals.append(i) 
    UMatrix = norm(UMatrix)
    return UMatrix




def find_genre(movie,movs):
    p = movs[movs["title"].str.contains(movie, case=False, regex=False, na=False)]
    
    if p.empty:
        return "No Movie Found"
    else:
        genres_string = p.iloc[0]["genres"]
        genre_list = genres_string.split("|")
        return genre_list





def pick_movies(fav_genres,movs):
    movieL = []
    for genre in fav_genres:
        filtered = movs[movs["genres"].str.contains(genre, case=False, na=False)]
        if filtered.empty:
            continue

        movieP = filtered.sort_values("avg", ascending=False)
        
        n_take = min(12, len(movieP))
        top_movies = movieP["title"].iloc[:n_take].tolist()
        movieL.extend(top_movies)
    return movieL





def probe_movies(movieL):
    unique_movies = list(set(movieL))
    sample_size = min(50, len(unique_movies))
    return random.sample(unique_movies, sample_size)



def user_refine(UMatrix, movie_vals, genre_cols1,movs):
    NUMatrix = UMatrix
    for i in range(len(movie_vals)):
        indexs = []
        genres1 = find_genre(movie_vals[i][0], movs)
        for g in range(len(genres1)):
            indexs.append(genre_cols1.index(genres1[g]))
        val = float(movie_vals[i][1]) - 3.5
        for j in range(len(indexs)):
            NUMatrix[indexs[j]] += val
    NUMatrix = norm(NUMatrix)
    return NUMatrix





def rec(NUMatrix, GMatrix, movie_vals,movs):
    M = GMatrix.to_numpy()
    u = np.array(NUMatrix)
    M = M / (np.linalg.norm(M, axis=1, keepdims=True) + 1e-12)
    u = u / np.linalg.norm(u)
    scores = M @ u
    end = movs.copy()
    end["score"] = scores
    end["final_score"] = (0.75*end["score"] + 0.125*np.log1p(end["n_ratings"]) + 0.125*end["avg"])
    end["normF"] = (end["final_score"] - end["final_score"].min()) / (end["final_score"].max() - end["final_score"].min())
    end["pred_rating"] = 1 + 4 * end["normF"]
    rated_titles = [m[0] for m in movie_vals]
    end = end[~end["title"].isin(rated_titles)]
    end = end.sort_values("final_score", ascending = False)
    top = end.head(10)
    return (top[["title", "genres", "pred_rating"]])
    

st.set_page_config(page_title="MovieMe", page_icon="üé¨", layout="centered")
def main():
    st.title("üé¨Movie Me")
    DATA_DIR = find_movielens_dir(EXPLICIT_PATH)
    movies = pd.read_csv(DATA_DIR / "movies.csv", usecols=["movieId", "title", "genres"])
    ratings = pd.read_csv(DATA_DIR / "ratings.csv", usecols=["userId", "movieId", "rating"])
    ratings = ratings.rename(columns={"userId": "user", "movieId": "item"})
    movies  = movies.rename(columns={"movieId": "item"})




    movie_stats = ratings.groupby("item")["rating"].agg(n_ratings="size", avg="mean")
    movie_stats = movie_stats.sort_values("n_ratings", ascending=False)
    minRatings = 25
    movs = movies.join(movie_stats, on="item").dropna(subset=["n_ratings"])
    movs = movs[movs["n_ratings"] >= minRatings]


    GMatrix = movs["genres"].str.get_dummies("|")
    GMatrix.index = movs["item"]
    GMatrix = GMatrix.div(np.linalg.norm(GMatrix, axis=1) + 1e-12, axis=0)
    genre_cols = GMatrix.columns.tolist()
    genre_cols1 = genre_cols

    if "page" not in st.session_state:
        st.session_state["page"] = "genres"
    if st.session_state["page"] == "genres":
        st.header("Welcome to the focal point for true movie recommendations!")
        user_name = st.text_input("Please Enter Your Name:")
        st.session_state["user"] = user_name
        fav_genres = st.multiselect(
        "üé¨ Pick your favorite movie genres (atleast 2):",
        ['Action', 'Adventure', 'Animation', 'Children', 'Comedy', 'Crime', 'Documentary', 'Drama', 'Fantasy', 'Film-Noir', 'Horror', 'IMAX', 'Musical', 'Mystery', 'Romance', 'Sci-Fi', 'Thriller', 'War', 'Western']
    )   
        if st.button("Next ‚û°Ô∏è"):
            st.session_state["user"] = user_name
            st.session_state["fav_genres"] = fav_genres
            st.session_state["page"] = "ratings"
            st.rerun()
        st.stop()

    if st.session_state["page"] == "ratings":
        UMatrix = user_pref(st.session_state["fav_genres"], genre_cols1)
        st.session_state["UMatrix"] = UMatrix
        movieL = pick_movies(st.session_state["fav_genres"],movs)
        if "movie_list_persisted" not in st.session_state: 
            st.session_state.movie_list_persisted = probe_movies(movieL) 
            movie_list = st.session_state.movie_list_persisted
        st.header("Please rate the following movies, select skip if you haven't watched the movie:")
        movie_vals = []
        if "movie_ratings" not in st.session_state: 
            st.session_state.movie_ratings = {}
        movie_vals = [[m, float(r)] for m, r in st.session_state.movie_ratings.items()
              if isinstance(r, (int, float)) and 1 <= float(r) <= 5]
        if "movie_list" not in st.session_state: 
            st.session_state.movie_list = probe_movies(movieL) 
            movie_list = st.session_state.movie_list
        if "next_v" not in st.session_state: 
            st.session_state.next_v = 7
        if "displayed_movies" not in st.session_state:
            st.session_state.displayed_movies = movie_list[:7]  
        movies = st.session_state.displayed_movies
        v = st.session_state.next_v
        def movie_card(movie, idx):
            bg = "#b6f2a2" if movie in st.session_state.movie_ratings and isinstance(st.session_state.movie_ratings[movie], (int, float)) else "#f0f0f0"
            slider_key = f"rate_{idx}"
            skip_key = f"skip_{idx}"

            st.markdown(
                f"""
                <div style="
                    background-color:{bg};
                    padding:15px;
                    border-radius:12px;
                    text-align:center;
                    box-shadow:0 0 5px rgba(0,0,0,0.15);
                    margin-bottom:20px;
                    width:100%;
                ">
                    <h4 style="margin:0 0 10px 0; color:#222; word-break:break-word; hyphens:auto; white-space:normal; font-size:14px;">{movie}</h4>
                </div>
                """,
                unsafe_allow_html=True,
            )

            current = st.session_state.movie_ratings.get(movie, 3)

            rating = st.number_input(
                "Enter a rating (1‚Äì5):",
                min_value=1,
                max_value=5,
                value=int(current) if isinstance(current, (int, float)) else 3,
                step=1,
                key=slider_key
            )

            if rating != current:
                st.session_state.movie_ratings[movie] = float(rating)
                st.rerun()

        
    
            if st.button("Skip", key=skip_key):     
                st.session_state.movie_ratings[movie] = "skipped"     
                if st.session_state.next_v < len(st.session_state.movie_list):         
                    new_movie = st.session_state.movie_list[st.session_state.next_v]        
                    movies[idx] = new_movie         
                    st.session_state.displayed_movies = movies         
                    del st.session_state.movie_ratings[movie]         
                    st.session_state.next_v += 1     
                    st.rerun()

                    
        rows = [st.columns(2), st.columns(2), st.columns(2), st.columns([1,2,1])]

        for r, row in enumerate(rows[:3]):
            for c in range(2):
                i = r * 2 + c
                with row[c]:
                    movie_card(movies[i], i)

        with rows[3][1]:
            movie_card(movies[6], 6)
        
        st.markdown("---")
    
        rated_count = len(movie_vals)
        st.info(f"Rated {rated_count}/7")

        if rated_count >= 7:
            if st.button("Continue to Recommendations"):
                st.session_state.movie_vals = movie_vals 
                st.session_state.page = "recommendations"
                st.rerun()

    if st.session_state["page"] == "recommendations":
        movie_vals = st.session_state.get("movie_vals", [])
        UMatrix = st.session_state["UMatrix"]
        NUMatrix = user_refine(UMatrix, movie_vals, genre_cols1,movs)
        st.subheader("üé• Your Top 10 Recommended Movies:")

        top = rec(NUMatrix, GMatrix, movie_vals, movs)
        st.dataframe(top[["title", "genres", "pred_rating"]])


if __name__ == "__main__":
    main()



    




